/*
 * task-procesamiento.c
 *
 *  Created on: 10 oct. 2019
 *      Author: Gaston
 */


#include "task-procesamiento.h"
#include "board.h"
#include <stdlib.h>
uint32_t adc[300]={1043,1064,1085,1106,1127,1148,1169,1189,1210,1230,1251,1271,1291,1312,1332,1351,1371,1391,1410,1429,1448,1467,1486,1504,1523,1541,1558,1576,1593,1610,1627,1644,1660,1676,1692,1707,1722,1737,1751,1766,1779,1793,1806,1819,1832,1844,1855,1867,1878,1889,1899,1909,1918,1927,1936,1944,1952,1960,1967,1974,1980,1986,1991,1996,2001,2005,2008,2012,2015,2017,2019,2021,2022,2022,2023,2022,2022,2021,2019,2017,2015,2012,2008,2005,2001,1996,1991,1986,1980,1974,1967,1960,1952,1944,1936,1927,1918,1909,1899,1889,1878,1867,1855,1844,1832,1819,1806,1793,1779,1766,1751,1737,1722,1707,1692,1676,1660,1644,1627,1610,1593,1576,1558,1541,1523,1504,1486,1467,1448,1429,1410,1391,1371,1351,1332,1312,1291,1271,1251,1230,1210,1189,1169,1148,1127,1106,1085,1064,1043,1023,1002,981,960,939,918,897,876,856,835,815,794,774,754,733,713,694,674,654,635,616,597,578,559,541,523,504,487,469,452,435,418,401,385,369,353,338,323,308,294,279,266,252,239,226,213,201,190,178,167,156,146,136,127,118,109,101,93,85,78,71,65,59,54,49,44,40,37,33,30,28,26,24,23,23,23,23,23,24,26,28,30,33,37,40,44,49,54,59,65,71,78,85,93,101,109,118,127,136,146,156,167,178,190,201,213,226,239,252,266,279,294,308,323,338,353,369,385,401,418,435,452,469,487,504,522,541,559,578,597,616,635,654,674,694,713,733,754,774,794,815,835,856,876,897,918,939,960,981,1002,1022};

//uint8_t signal[300] : Se√±al ya procesada como para entrar correctamente en la pantalla
uint8_t signal[300];
char str_Vm[6];

enum {IDLE,PROCESSING}processing_state=IDLE;

void task_procesamiento(void)
{
	static uint8_t flag;
 	uint32_t i;
	float Vm=0;
	if (processing_state==IDLE) return;


	for (i=0;i<300;i++)
	{
		Vm+=adc[i];
		signal[i]=(uint8_t)(220-((adc[i]*44)/819));
	}
	Vm/=300;
	Vm-=2047.5; //Le resto el offset de continua del ADC

	strcpy(str_Vm,"1,3");
	//itoa(Vm,str_Vm,10);

	//Indico a la tarea solicitante que termine
	processing_state=IDLE;

}
